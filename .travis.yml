os: linux
dist: bionic

language: scala

scala:
  - "2.12.8"

python:
  - "3.7"

jdk:
  - openjdk10

cache:
  directories:
    - "$HOME/.ivy2"

addons:
  apt:
    packages:
      - expect

services:
  - docker

env:
  global:
    - GDB_HEAP_SIZE=2G
    - KNORA_GDB_LICENSE=$TRAVIS_BUILD_DIR/knora-api/travis/graphdb.license

before_install:
  - git clone -b develop --single-branch --depth 1 https://github.com/dasch-swiss/knora-api.git
  - cd $TRAVIS_BUILD_DIR/knora-api
  - openssl aes-256-cbc -K $encrypted_ec8f5e0fa991_key -iv $encrypted_ec8f5e0fa991_iv -in $TRAVIS_BUILD_DIR/knora-api/travis/secrets.tar.enc -out $TRAVIS_BUILD_DIR/knora-api/travis/secrets.tar -d
  - tar -C $TRAVIS_BUILD_DIR/knora-api/travis -xvf $TRAVIS_BUILD_DIR/knora-api/travis/secrets.tar

script:
  - cd $TRAVIS_BUILD_DIR/knora-api && make stack-up
  - sleep 15
  - make init-db-test-minimal
  - sleep 15
  - make stack-restart-api
  - cd $TRAVIS_BUILD_DIR
  - pyenv shell 3.7.1
  - pip3 install -r requirements.txt
  - pip3 install .
  - make test
