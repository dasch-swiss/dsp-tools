@prefix sh:         <http://www.w3.org/ns/shacl#> .
@prefix dash:       <http://datashapes.org/dash#> .
@prefix rdf:        <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:       <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd:        <http://www.w3.org/2001/XMLSchema#> .
@prefix owl:        <http://www.w3.org/2002/07/owl#> .
@prefix knora-api:  <http://api.knora.org/ontology/knora-api/v2#> .

@prefix api-shapes: <http://api.knora.org/ontology/knora-api/shapes/v2#> .

#########################################
# GENERAL SHAPES
#########################################

########################
# UNIQUE VALUE SHAPE
########################

api-shapes:UniqueValue_Shape
  a              sh:NodeShape ;
  sh:targetClass knora-api:Resource ;
  sh:sparql      [
                   a          sh:SPARQLConstraint ;
                   sh:select  """
        PREFIX rdfs:       <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX knora-api:  <http://api.knora.org/ontology/knora-api/v2#>
        PREFIX api-shapes: <http://api.knora.org/ontology/knora-api/shapes/v2#>

            SELECT $this ?path ?value WHERE {

                $this ?path ?valueClass .

                {
                    ?prop rdfs:subPropertyOf knora-api:valueHas .
                    ?valueClass ?prop ?value .
                }
                UNION
                {
                    ?valueClass knora-api:valueAsString|api-shapes:linkValueHasTargetID|api-shapes:listNodeAsString ?value .
                }
            }
            GROUP BY $this ?path ?value
            HAVING (COUNT(?value) > 1)
                    """ ;
                   sh:message "A resource may not have the same property and value more than one time." ;
                 ] ;
  sh:severity    sh:Violation .


########################
# Generic Resource Shape
########################

api-shapes:Resource_Shape
  a              sh:NodeShape ;
  sh:targetClass knora-api:Resource ;
  sh:name        "Validates generic properties of all Resources" ;
  sh:property    [
                    a           sh:PropertyShape ;
                    sh:path     rdfs:label ;
                    sh:datatype xsd:string ;
                    sh:pattern  "\\s*\\S+\\s*" ;
                    sh:minCount 1 ;
                    sh:maxCount 1 ;
                    sh:severity sh:Violation ;
                    sh:message  "The label must be a non-empty string" ;
                  ] ,
                  [
                    # Currently StandOff are attached directly to the resource and not in a LinkValue,
                    # therefore we do not validate it like a normal link with a LinkValue
                    a           sh:PropertyShape ;
                    sh:path     knora-api:hasStandoffLinkTo ;
                    sh:class    knora-api:Resource ;
                    sh:severity sh:Violation ;
                    sh:message  "A stand-off link must target an existing resource." ;
                  ] .


########################
# USER FACING VALUES
########################

api-shapes:Value_ClassShape
  a              sh:NodeShape ;
  sh:targetClass knora-api:Value ;
  sh:property    [
                    a           sh:PropertyShape ;
                    sh:path     knora-api:valueHasComment ;
                    sh:datatype xsd:string ;
                    sh:pattern  "\\s*\\S+\\s*" ;
                    sh:minCount 0 ;
                    sh:maxCount 1 ;
                    sh:severity sh:Violation ;
                    sh:message  "The comment on the value must be a non-empty string" ;
                 ] .


##############
# BooleanValue
api-shapes:BooleanValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:BooleanValue ;
  sh:property    api-shapes:booleanValueAsBoolean_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "BooleanValue" .

api-shapes:booleanValueAsBoolean_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:booleanValueAsBoolean ;
  sh:datatype xsd:boolean ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "A BooleanValue requires exactly one valid boolean".

##############
# ColorValue
api-shapes:ColorValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:ColorValue ;
  sh:property    api-shapes:colorValueAsColor_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "ColorValue" .

api-shapes:colorValueAsColor_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:colorValueAsColor ;
  sh:datatype xsd:string ;
  sh:pattern  "^#([0-9a-fA-F]{3}){1,2}$" ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "A ColorValue requires exactly one valid color" .

##############
# DateValue
api-shapes:DateValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:DateValue ;
  sh:property    api-shapes:valueAsString_DateValueShape ;
  sh:severity    sh:Violation ;
  sh:message     "DateValue" .

# Currently it is only checked that the string value is not empty
# To validate the DateValue as the API receives it, the Date should be taken apart
api-shapes:valueAsString_DateValueShape
  a           sh:PropertyShape ;
  sh:path     knora-api:valueAsString ;
  sh:datatype xsd:string ;
  sh:pattern  "\\s*\\S+\\s*" ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "A DateValue requires a valid Date" .

##############
# DecimalValue
api-shapes:DecimalValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:DecimalValue ;
  sh:property    api-shapes:decimalValueAsDecimal_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "DecimalValue" .

api-shapes:decimalValueAsDecimal_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:decimalValueAsDecimal ;
  sh:datatype xsd:decimal ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "A DecimalValue requires exactly one valid decimal" .

##############
# GeonameValue
api-shapes:GeonameValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:GeonameValue ;
  sh:property    api-shapes:geonameValueAsGeonameCode_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "GeonameValue" .

api-shapes:geonameValueAsGeonameCode_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:geonameValueAsGeonameCode ;
  sh:datatype xsd:string ;
  sh:pattern  "^\\d+$" ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "The value must be a valid geoname code" .

##############
# GeomValue
api-shapes:GeomValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:GeomValue ;
  sh:property    api-shapes:geometryValueAsGeometry_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "GeomValue" .

api-shapes:geometryValueAsGeometry_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:geometryValueAsGeometry ;
  sh:datatype xsd:string ;
  sh:pattern  "\\s*\\S+\\s*" ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "The value must be a valid geometry JSON object" .

##############
# IntervalValue
api-shapes:IntervalValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:IntervalValue ;
  sh:property    [
                   sh:path knora-api:intervalValueHasStart ;
		               sh:lessThan knora-api:intervalValueHasEnd ;
                   sh:severity sh:Violation ;
                   sh:message "The start of the interval must be smaller than the end." ;
                 ] ,
                 api-shapes:intervalValueHasStart_PropShape ,
                 api-shapes:intervalValueHasEnd_PropShape ;
  sh:severity    sh:Violation ;
  sh:message     "IntervalValue" .

### knora-api:intervalValueHasStart
api-shapes:intervalValueHasStart_PropShape
  a               sh:PropertyShape ;
  sh:path         knora-api:intervalValueHasStart ;
  sh:datatype     xsd:decimal ;
  sh:minInclusive 0 ;
  sh:minCount     1 ;
  sh:maxCount     1 ;
  sh:severity     sh:Violation ;
  sh:message      "The interval start must be a non-negative integer or decimal." .

### knora-api:intervalValueHasEnd
api-shapes:intervalValueHasEnd_PropShape
  a               sh:PropertyShape ;
  sh:path         knora-api:intervalValueHasEnd ;
  sh:datatype     xsd:decimal ;
  sh:minExclusive 0 ;
  sh:minCount     1 ;
  sh:maxCount     1 ;
  sh:severity     sh:Violation ;
  sh:message      "The interval end must be an integer or decimal that is larger than 0." .

##############
# IntValue
api-shapes:IntValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:IntValue ;
  sh:property    api-shapes:intValueAsInt_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "IntValue" .

api-shapes:intValueAsInt_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:intValueAsInt ;
  sh:datatype xsd:integer ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "An IntValue requires exactly one valid integer" .

##############
# LinkValue

# The target of the LinkValue is ontology specific.
# The Shape is constructed through the SPARQL queries

##############
# ListValue

# The target of the ListValue is ontology specific.
# The Shape is constructed through the SPARQL queries

##############
# TextValue

###
# SimpleTextValue

# This validates that the Simple TextValue is correct
api-shapes:SimpleTextValue_ClassShape
  a           sh:NodeShape ;
  sh:name     "Ensures that the properties for a simple text value are used" ;
  sh:property api-shapes:SimpleTextValue_PropShape ,
              api-shapes:valueAsString_Shape ;
  sh:severity sh:Violation .

# Because it is not a separate class we have to check the cardinality of the property
api-shapes:SimpleTextValue_PropShape
  a           sh:PropertyShape ;
  sh:path     knora-api:valueAsString ;
  sh:datatype xsd:string ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "TextValue without formatting" .

api-shapes:valueAsString_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:valueAsString ;
  sh:datatype xsd:string ;
  sh:pattern  "\\s*\\S+\\s*" ;
  sh:severity sh:Violation ;
  sh:message  "The value must be a non-empty string" .

###
# FormattedTextValue

# This validates that the Rich TextValue is correct
api-shapes:FormattedTextValue_ClassShape
  a           sh:NodeShape ;
  sh:name     "Ensures that the properties for a formatted text value are used" ;
  sh:property api-shapes:FormattedTextValue_PropShape ,
              api-shapes:textValueAsXml_Shape ;
  sh:severity sh:Violation .

# Because it is not a separate class we have to check the cardinality of the property
api-shapes:FormattedTextValue_PropShape
  a           sh:PropertyShape ;
  sh:path     knora-api:textValueAsXml ;
  sh:datatype xsd:string ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "TextValue with formatting" .

api-shapes:textValueAsXml_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:textValueAsXml ;
  sh:datatype xsd:string ;
  sh:pattern  "\\s*\\S+\\s*" ;
  sh:severity sh:Violation ;
  sh:message  "The value must be a non-empty string" .

##############
# TimeValue
api-shapes:TimeValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:TimeValue ;
  sh:property    api-shapes:timeValueAsTimeStamp_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "TimeValue" .

api-shapes:timeValueAsTimeStamp_Shape
  a           sh:PropertyShape ;
  sh:path     knora-api:timeValueAsTimeStamp ;
  sh:datatype xsd:dateTimeStamp ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation ;
  sh:message  "A TimeValue requires exactly one valid xsd:dateTimeStamp" .

##############
# UriValue
api-shapes:UriValue_ClassShape
  a              sh:NodeShape ;
  sh:name        "Validates the properties used with this targetClass" ;
  sh:targetClass knora-api:UriValue ;
  sh:property    api-shapes:uriValueAsUri_Shape ;
  sh:severity    sh:Violation ;
  sh:message     "UriValue" .

api-shapes:uriValueAsUri_Shape
  a           sh:PropertyShape ;
  sh:message  "A UriValue requires exactly one valid xsd:anyURI" ;
  sh:path     knora-api:uriValueAsUri ;
  sh:datatype xsd:anyURI ;
  sh:minCount 1 ;
  sh:maxCount 1 ;
  sh:severity sh:Violation .

#########################################
# KNORA-API IN-BUILT PROPERTIES
#########################################

### knora-api:hasLinkTo

api-shapes:hasLinkTo_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:hasLinkTo ;
  sh:class   knora-api:LinkValue ;
  sh:node    api-shapes:hasLinkTo_NodeShape ;
  sh:message "This property requires a LinkValue" .

api-shapes:hasLinkTo_NodeShape
  a           sh:NodeShape ;
  sh:name     "This ensures that the target of the property is of type Resource, i.e. exists in the graph." ;
  sh:property [
                a          sh:PropertyShape ;
                sh:path    api-shapes:linkValueHasTargetID ;
                sh:class   knora-api:Resource ;
                sh:message "Range is knora-api:Resource or a subclass." ;
              ] ;
  sh:severity sh:Violation .


### knora-api:isRegionOf

api-shapes:isRegionOf_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:isRegionOf ;
  sh:class   knora-api:LinkValue ;
  sh:node    api-shapes:isRegionOf_NodeShape ;
  sh:message "This property requires an LinkValue" .

api-shapes:isRegionOf_NodeShape
  a           sh:NodeShape ;
  sh:name     "This ensures that the target of the property is of type Representation, i.e. exists in the graph." ;
  sh:property [
                a          sh:PropertyShape ;
                sh:path    api-shapes:linkValueHasTargetID ;
                sh:class   knora-api:Representation ;
                sh:message "http://api.knora.org/ontology/knora-api/v2#Representation" ;
              ] ;
  sh:severity sh:Violation .


### knora-api:hasComment

api-shapes:hasComment_PropertyShape
  a       sh:PropertyShape ;
  sh:path knora-api:hasComment ;
  sh:node api-shapes:FormattedTextValue_ClassShape .


### knora-api:hasColor

api-shapes:hasColor_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:hasColor ;
  sh:class   knora-api:ColorValue ;
  sh:message "This property requires an ColorValue" .


### knora-api:hasGeometry

api-shapes:hasGeometry_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:hasGeometry ;
  sh:class   knora-api:GeomValue ;
  sh:message "This property requires an GeomValue" .


### knora-api:seqnum and knora-api:isPartOf

# dash:coExistsWith ensures that isPartOf also needs seqnum. There is no need for a second shape.
api-shapes:seqnum_PropShape
  a                 sh:PropertyShape ;
  sh:path           knora-api:seqnum ;
  dash:coExistsWith knora-api:isPartOf ;
  sh:severity       sh:Violation ;
  sh:message        """
                    The property seqnum or isPartOf (or sub-properties of them) must be used together.
                    This resource only used one of the properties.
                    """ .


### knora-api:hasSegmentBounds

api-shapes:hasSegmentBounds_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:hasSegmentBounds ;
  sh:class   knora-api:IntervalValue ;
  sh:message "This property requires an IntervalValue" .


### knora-api:relatesTo

api-shapes:relatesTo_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:relatesTo ;
  sh:class   knora-api:LinkValue ;
  sh:node    api-shapes:relatesTo_NodeShape ;
  sh:message "This property requires an LinkValue" .

api-shapes:relatesTo_NodeShape
  a           sh:NodeShape ;
  sh:name     "This ensures that the target of the property is of type Resource, i.e. exists in the graph." ;
  sh:property [
                a          sh:PropertyShape ;
                sh:path    api-shapes:linkValueHasTargetID ;
                sh:class   knora-api:Resource ;
                sh:message "Range is knora-api:Resource or a subclass." ;
              ] ;
  sh:severity sh:Violation .


### knora-api:isVideoSegmentOf

api-shapes:isVideoSegmentOf_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:isVideoSegmentOf ;
  sh:class   knora-api:LinkValue ;
  sh:node    api-shapes:isVideoSegmentOf_NodeShape ;
  sh:message "This property requires an LinkValue" .

api-shapes:isVideoSegmentOf_NodeShape
  a           sh:NodeShape ;
  sh:name     "This ensures that the target of the property is of type MovingImageRepresentation, i.e. exists in the graph." ;
  sh:property [
                a          sh:PropertyShape ;
                sh:path    api-shapes:linkValueHasTargetID ;
                sh:class   knora-api:MovingImageRepresentation ;
                sh:message "http://api.knora.org/ontology/knora-api/v2#MovingImageRepresentation" ;
              ] ;
  sh:severity sh:Violation .


### knora-api:isAudioSegmentOf

api-shapes:isAudioSegmentOf_PropertyShape
  a          sh:PropertyShape ;
  sh:path    knora-api:isAudioSegmentOf ;
  sh:class   knora-api:LinkValue ;
  sh:node    api-shapes:isAudioSegmentOf_NodeShape ;
  sh:message "This property requires an LinkValue" .

api-shapes:isAudioSegmentOf_NodeShape
  a           sh:NodeShape ;
  sh:name     "This ensures that the target of the property is of type AudioRepresentation, i.e. exists in the graph." ;
  sh:property [
                a          sh:PropertyShape ;
                sh:path    api-shapes:linkValueHasTargetID ;
                sh:class   knora-api:AudioRepresentation ;
                sh:message "http://api.knora.org/ontology/knora-api/v2#AudioRepresentation" ;
              ] ;
  sh:severity sh:Violation .


### knora-api:hasDescription

api-shapes:hasDescription_PropertyShape
  a       sh:PropertyShape ;
  sh:path knora-api:hasDescription ;
  sh:node api-shapes:FormattedTextValue_ClassShape .


### knora-api:hasTitle

api-shapes:hasTitle_PropertyShape
  a       sh:PropertyShape ;
  sh:path knora-api:hasTitle ;
  sh:node api-shapes:SimpleTextValue_ClassShape .


### knora-api:hasKeyword

api-shapes:hasKeyword_PropertyShape
  a       sh:PropertyShape ;
  sh:path knora-api:hasKeyword ;
  sh:node api-shapes:SimpleTextValue_ClassShape .


#########################################
# DSP BUILT IN RESOURCES
#########################################

# The built-in resources are are validated strictly by the xsd,
# therefore a mismatch of value type does not need to be evaluated the way user defined properties need to be

###########################
# LinkObj

api-shapes:LinkObj_ResourceShape
  a              sh:NodeShape ;
  sh:name        "Validates the LinkObj resource" ;
  sh:targetClass knora-api:LinkObj ;
  sh:property    api-shapes:hasLinkTo_PropertyShape ,
                 api-shapes:hasComment_PropertyShape ;
  sh:severity    sh:Violation .


###########################
# Region

api-shapes:Region_ResourceShape
  a              sh:NodeShape ;
  sh:name        "Validates the Region resource" ;
  sh:targetClass knora-api:Region ;
  sh:property    api-shapes:isRegionOf_PropertyShape ,
                 api-shapes:hasColor_PropertyShape ,
                 api-shapes:hasGeometry_PropertyShape ,
                 api-shapes:hasComment_PropertyShape ;
  sh:severity    sh:Violation .


###########################
# AudioSegment

api-shapes:AudioSegment_ResourceShape
  a              sh:NodeShape ;
  sh:name        "Validates the AudioSegment resource" ;
  sh:targetClass knora-api:AudioSegment ;
  sh:property    api-shapes:hasComment_PropertyShape ,
                 api-shapes:hasSegmentBounds_PropertyShape ,
                 api-shapes:relatesTo_PropertyShape ,
                 api-shapes:isAudioSegmentOf_PropertyShape ,
                 api-shapes:hasDescription_PropertyShape ,
                 api-shapes:hasTitle_PropertyShape ,
                 api-shapes:hasKeyword_PropertyShape ;
  sh:severity    sh:Violation .


###########################
# VideoSegment

api-shapes:VideoSegment_ResourceShape
  a              sh:NodeShape ;
  sh:name        "Validates the VideoSegment resource" ;
  sh:targetClass knora-api:VideoSegment ;
  sh:property    api-shapes:hasComment_PropertyShape ,
                 api-shapes:hasSegmentBounds_PropertyShape ,
                 api-shapes:relatesTo_PropertyShape ,
                 api-shapes:isVideoSegmentOf_PropertyShape ,
                 api-shapes:hasDescription_PropertyShape ,
                 api-shapes:hasTitle_PropertyShape ,
                 api-shapes:hasKeyword_PropertyShape  ;
  sh:severity    sh:Violation .
