@prefix owl:         <http://www.w3.org/2002/07/owl#> .
@prefix rdf:         <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:        <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd:         <http://www.w3.org/2001/XMLSchema#> .
@prefix sh:          <http://www.w3.org/ns/shacl#> .

@prefix val-shapes:  <http://api.knora.org/validation-shapes#> .
@prefix val-onto:    <http://api.knora.org/validation-onto#> .
@prefix onto:        <http://0.0.0.0:3333/ontology/9999/onto/v2#> .
@prefix onto-shapes: <http://validation-9999/onto-shapes#> .

###################
# Class Shapes
###################

onto-shapes:NormalClass_NodeShape
  a                    sh:NodeShape ;
  sh:targetClass       onto:NormalClass ;
  sh:property          onto-shapes:hasSimpleText_PropShape ,
                       onto-shapes:listProp_PropShape ,
                       onto-shapes:linkProp_PropShape ;
  sh:node              val-shapes:UniqueValuesShape ;
  sh:ignoredProperties ( rdf:type rdfs:label ) ;
  sh:closed             true .

#######

onto-shapes:CardOneResource_Shape
  a                    sh:NodeShape ;
  sh:targetClass       onto:CardOneResource ;
  sh:property          [
                         a           sh:PropertyShape ;
                         sh:path     onto:hasSimpleText ;
                         sh:minCount 1 ;
                         sh:maxCount 1 ;
                         sh:severity sh:Violation ;
                         sh:message  "Cardinality: 'onto:hasSimpleText' -> exactly 1" ;
                       ] ,
                       onto-shapes:hasSimpleText_PropShape ;
  sh:node              val-shapes:UniqueValuesShape;
  sh:ignoredProperties ( rdf:type rdfs:label ) ;
  sh:closed            true .

#######

onto-shapes:SubClass_Shape
  a                    sh:NodeShape ;
  sh:targetClass       onto:SubClass ;
  sh:property          [
                         a           sh:PropertyShape ;
                         sh:path     onto:hasSimpleText ;
                         sh:minCount 1 ;
                         sh:maxCount 1 ;
                         sh:severity sh:Violation ;
                         sh:message  "Cardinality: 'onto:hasSimpleText' -> exactly 1" ;
                       ] ,
                       onto-shapes:hasSimpleText_PropShape ;
  sh:node              val-shapes:UniqueValuesShape;
  sh:ignoredProperties ( rdf:type rdfs:label ) ;
  sh:closed            true .

###################
# Property Shapes
###################

onto-shapes:hasSimpleText_PropShape
  a       sh:PropertyShape  ;
  sh:path onto:hasSimpleText ;
  sh:node val-shapes:SimpleText_ClassShape , val-shapes:SimpleText_NodeShape .

#######

onto-shapes:listProp_PropShape
  a       sh:PropertyShape ;
  sh:path onto:listProp ;
  sh:node val-shapes:ListValue_ClassShape , onto-shapes:listProp_NodeShape .


onto-shapes:listProp_NodeShape
  a           sh:NodeShape ;
  sh:name     "Validates the content of the ListValue with the specific property." ;
  sh:property [
                a         sh:PropertyShape ;
                sh:path   val-onto:hasValue ;
                sh:in     ( "n1" "n1.1" "n1.1.1" ) ;
                sh:message "Unknown list node."
              ] ,
              [
                a               sh:PropertyShape ;
                sh:path         val-onto:hasListName ;
                sh:defaultValue "onlyList" ;
                sh:message      "Unknown list name."
              ] ;
  sh:severity sh:Violation .

#######

onto-shapes:linkProp_PropShape
  a sh:PropertyShape ;
  sh:path onto:linkProp ;
  sh:node val-shapes:LinkValue_ClassShape , onto-shapes:linkProp_NodeShape .


# GOOD DATA DOES NOT PASS (INHERITANCE PROBLEM???)
# FINDS VIOLATIONS
onto-shapes:linkProp_NodeShape
  a              sh:NodeShape ;
  sh:name        "Validates class of target." ;
  sh:property    [
                    a            sh:PropertyShape ;
                    sh:path      val-onto:hasValue ;
                    sh:class     onto:CardOneResource ;
                    sh:message   "Target must be of type onto:CardOneResource or a subclass of it." ;
                 ] ;
  sh:severity    sh:Violation .


# DOES NOT FIND VIOLATIONS, GOOD DATA PASSES
#onto-shapes:linkProp_NodeShape
#  a                   sh:NodeShape ;
#  sh:sparql           [
#                        a          sh:SPARQLConstraint ;
#                        sh:message "Target must be of type onto:CardOneResource or a subclass of it." ;
#                        sh:select  """
#                            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
#                            SELECT $this
#                            WHERE {
#                            $this onto:linkProp ?linkValue .
#                            ?linkValue val-onto:hasLinkValueTarget ?target .
#                                FILTER NOT EXISTS {
#                                    ?target a/rdfs:subClassOf* onto:CardOneResource .
#                                }
#                            }
#                        """ ;
#                      ] ;
#  sh:severity         sh:Violation .