@prefix owl:         <http://www.w3.org/2002/07/owl#> .
@prefix rdf:         <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:        <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd:         <http://www.w3.org/2001/XMLSchema#> .
@prefix sh:          <http://www.w3.org/ns/shacl#> .

@prefix val-shapes:  <http://api.knora.org/validation-shapes#> .
@prefix val-onto:    <http://api.knora.org/validation-onto#> .
@prefix onto:        <http://0.0.0.0:3333/ontology/9999/onto/v2#> .
@prefix onto-shapes: <http://validation-9999/onto-shapes#> .


onto-shapes:NormalClass_NodeShape
  a                    sh:NodeShape ;
  sh:targetClass       onto:NormalClass ;
  sh:property           [
                          a           sh:PropertyShape ;
                          sh:path     onto:hasSimpleText ;
                        ] ,
                        [
                          a           sh:PropertyShape ;
                          sh:path     onto:linkProp ;
                        ] ,
                        [
                          a           sh:PropertyShape ;
                          sh:path     onto:listProp ;
                        ] ;
  sh:node              val-shapes:UniqueValuesShape ;
  sh:ignoredProperties ( rdf:type rdfs:label ) ;
  sh:closed             true .

#######

onto-shapes:CardOneResource_Shape
  a                    sh:NodeShape ;
  sh:targetClass       onto:CardOneResource ;
  sh:property          [
                         a           sh:PropertyShape ;
                         sh:path     onto:hasSimpleText ;
                         sh:minCount 1 ;
                         sh:maxCount 1 ;
                         sh:severity sh:Violation ;
                         sh:message  "Cardinality: 'onto:hasSimpleText' -> exactly 1" ;
                       ] ,
                       [
                          a           sh:PropertyShape ;
                          sh:path     onto:hasSimpleText ;
                       ] ;
  sh:node              val-shapes:UniqueValuesShape;
  sh:ignoredProperties ( rdf:type rdfs:label ) ;
  sh:closed            true .

#######

onto-shapes:SubClass_Shape
  a                    sh:NodeShape ;
  sh:targetClass       onto:SubClass ;
  sh:property          [
                         a           sh:PropertyShape ;
                         sh:path     onto:hasSimpleText ;
                         sh:minCount 1 ;
                         sh:maxCount 1 ;
                         sh:severity sh:Violation ;
                         sh:message  "Cardinality: 'onto:hasSimpleText' -> exactly 1" ;
                       ] ,
                       [
                          a           sh:PropertyShape ;
                          sh:path     onto:hasSimpleText ;
                       ] ;
  sh:node              val-shapes:UniqueValuesShape;
  sh:ignoredProperties ( rdf:type rdfs:label ) ;
  sh:closed            true .

# Since all Values are rdfs:subClass of val-onto:Value, this applies to all values.
val-shapes:UniqueValuesShape
  a           sh:NodeShape ;
  sh:sparql   [
                a          sh:SPARQLConstraint ;
                sh:message "A resource may not have the same property and value more than one time." ;
                sh:select  """
                    PREFIX val-onto: <http://api.knora.org/validation-onto#>
                    SELECT $this ?value WHERE {
                      $this ?someProperty ?valueClass .

                      ?valueClass val-onto:hasValue ?value .
                    }
                    GROUP BY $this ?someProperty ?value
                    HAVING (COUNT(?value) > 1)
                """ ;
              ] ;
  sh:severity sh:Violation .
